---
layout: post
title: "bpmnç¬”è®°"
date: 2020-10-26 15:05:50 +0800
subtitle: 'bpmnç¬”è®°'
tags: bpmn æµç¨‹å›¾
categories: æŠ€æœ¯
---

# bpmnå®ç°è‡ªå®šä¹‰æµç¨‹æ„å›¾

> æ ¹æ® [bpmnæ–‡æ¡£](https://github.com/PL-FE/bpmn-doc/blob/main/doc/baseBpmn.md) ä»¥åŠ[Bpmn.jsåŸºç¡€ API](https://blog.51cto.com/u_15127666/2785788) æ€»ç»“çš„éšç¬”ï¼Œå¯ä»¥åšä¸€äº›å‚è€ƒã€‚

## ä»€ä¹ˆæ˜¯æµç¨‹å¼•æ“ï¼Ÿ
> æµç¨‹å¼•æ“æ€»çš„æ¥è¯´å°±æ˜¯ç”¨æ¥é©±åŠ¨ä¸šåŠ¡æŒ‰ç…§æˆ‘è®¾å®šçš„å›ºå®šæµç¨‹å»æµè½¬çš„ä¸œè¥¿ï¼Œåœ¨å¤æ‚å¤šå˜çš„ä¸šåŠ¡æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ—¢å®šçš„æµç¨‹èƒ½å¤Ÿå¤§å¤§é™ä½æˆ‘ä»¬è®¾è®¡ä¸šåŠ¡çš„æˆæœ¬ï¼Œå¹¶ä¸”ä¿è¯äº†æˆ‘ä»¬ä¸šåŠ¡æ‰§è¡Œçš„å‡†ç¡®æ€§ã€‚(è´­ç‰©ä¸šåŠ¡ï¼Œä¸­å°æ”¯æŒ)

## 1.åˆå§‹åŒ–é¡µé¢

### 1. ä¾èµ–å®‰è£…

``` node
npm install bpmn-js -S
```

### 2. é¡µé¢æ¥æ”¶å†…å®¹

+ HTMl

```html
<div ref="canvas" class="canves"></div>
```

+ CSS

### 3.åˆå§‹åŒ–é¡µé¢

```js
import Modeler from 'bpmn-js/lib/Modeler'
import 'bpmn-js/dist/assets/diagram-js.css' // å·¦è¾¹å·¥å…·æ ä»¥åŠç¼–è¾‘èŠ‚ç‚¹çš„æ ·å¼
import 'bpmn-js/dist/assets/bpmn-font/css/bpmn.css'
import 'bpmn-js/dist/assets/bpmn-font/css/bpmn-codes.css'
import 'bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css'
import { xmlStr } from './xmlData.js'
export default {
  data() {
    return {
      bpmnModeler: null
    }
  },
  async mounted() {
    this.bpmnModeler = new Modeler({
      container: this.$refs.canvas
    })

    try {
      const { warnings } = await this.bpmnModeler.importXML(xmlStr)//xmlSträ¸ºå¯¼å…¥çš„xmlæ–‡ä»¶
      // è°ƒæ•´åœ¨æ­£ä¸­é—´
      this.bpmnModeler.get('canvas').zoom('fit-viewport', 'auto')
      console.log('rendered')
    } catch (err) {
      console.log('error rendering', err)
    }
  }
}
```

+ xmlStr æ¨¡æ¿

```xml
xmlStr = `<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="sid-38422fae-e03e-43a3-bef4-bd33b32041b2" targetNamespace="http://bpmn.io/bpmn" exporter="bpmn-js (https://demo.bpmn.io)" exporterVersion="5.1.2">
<process id="Process_1" isExecutable="false">
    
</process>
<bpmndi:BPMNDiagram id="BpmnDiagram_1">
    <bpmndi:BPMNPlane id="BpmnPlane_1" bpmnElement="Process_1">
    
    </bpmndi:BPMNPlane>
</bpmndi:BPMNDiagram>
</definitions>`
```

## 2.bpmnå†…éƒ¨

> åŒ…å«äº† **diagram-jsï¼ˆç”¨äºå›¾åƒã€è¿çº¿äº¤äº’å’Œå»ºæ¨¡ï¼‰** å’Œ **bpmn-moddleï¼ˆè¯»å†™ BPMN å…ƒæ¨¡å‹ï¼‰**

## 3.è‡ªå®šä¹‰ Palette ï¼ˆå·¥å…·æ ï¼‰

### 1.æµç¨‹å·¥å…·æ é…ç½®æ 
>æ–°å»ºé…ç½®æ–‡ä»¶ paletteEntries.js ,

```js

	'hand-tool': {//æŠ“æ‰‹å·¥å…·
            group: 'tools',
            className: 'bpmn-icon-hand-tool',
            title: translate('Activate the hand tool'),
            action: {
                click: function(event) {
                    handTool.activateHand(event);
                }
            }
        },
        'space-tool': {//åˆ›å»º/åˆ é™¤ç©ºé—´å·¥å…·
            group: 'tools',
            className: 'bpmn-icon-space-tool',
            title: translate('Activate the create/remove space tool'),
            action: {
                click: function(event) {
                    spaceTool.activateSelection(event);
                }
            }
        },
        'lasso-tool': {//ç´¢å¥—å·¥å…·
            group: 'tools',
            className: 'bpmn-icon-lasso-tool',
            title: translate('Activate the lasso tool'),
            action: {
                click: function(event) {
                    lassoTool.activateSelection(event);
                }
            }
        },
        'global-connect-tool': {//å…¨å±€è¿æ¥å·¥å…·
            group: 'tools',
            className: 'bpmn-icon-connection-multi',
            title: translate('Activate the global connect tool'),
            action: {
                click: function(event) {
                    globalConnect.toggle(event);
                }
            }
        },
        'tool-separator': {//å·¥å…·åˆ†å‰²çº¿
            group: 'tools',
            separator: true
        },
        'create.start-event': createAction(//å¼€å§‹äº‹ä»¶
            'bpmn:StartEvent', 'event', 'bpmn-icon-start-event-none',
            translate('Create StartEvent')
        ),
        'create.end-event': createAction(//ç»“æŸäº‹ä»¶
            'bpmn:EndEvent', 'event', 'bpmn-icon-end-event-none',
            translate('Create EndEvent')
        ),
        'create.intermediate-event': createAction(//ä¸­é—´/è¾¹ç•Œäº‹ä»¶
            'bpmn:IntermediateThrowEvent', 'event', 'bpmn-icon-intermediate-event-none',
            translate('Create Intermediate/Boundary Event')
        ),
        'event-separator': {//äº‹ä»¶åˆ†å‰²çº¿
            group: 'events',
            separator: true
        },
        'create.exclusive-gateway': createAction(//äº’æ–¥ç½‘å…³
            'bpmn:ExclusiveGateway', 'gateway', 'bpmn-icon-gateway-xor',
            translate('Create ExclusiveGateway')
        ),
        'create.parallel-gateway': createAction(//å¹¶è¡Œç½‘å…³
            'bpmn:ParallelGateway', 'gateway', 'bpmn-icon-gateway-parallel',
            translate('Create ParallelGateway')
        ),
        'create.inclusive-gateway': createAction(//ç›¸å®¹ç½‘å…³
            'bpmn:InclusiveGateway', 'gateway', 'bpmn-icon-gateway-or',
            translate('Create InclusiveGateway')
        ),
        'create.complex-gateway': createAction(//å¤æ‚ç½‘å…³
            'bpmn:ComplexGateway', 'gateway', 'bpmn-icon-gateway-complex',
            translate('Create ComplexGateway')
        ),
        'create.event-based-gateway': createAction(//äº‹ä»¶ç½‘å…³
            'bpmn:EventBasedGateway', 'gateway', 'bpmn-icon-gateway-eventbased',
            translate('Create EventbasedGateway')
        ),
        'gateway-separator': {//ç½‘å…³åˆ†å‰²çº¿
            group: 'gateways',
            separator: true
        },
        'create.task': createAction(//ç©ºç™½ä»»åŠ¡
            'bpmn:Task', 'activity', 'bpmn-icon-task',
            translate('Create Task')
        ),
        'create.user-task': createAction(//ç”¨æˆ·ä»»åŠ¡
            'bpmn:UserTask', 'activity', 'bpmn-icon-user-task',
            translate('Create UserTask')
        ),
        'create.send-task': createAction(//å‘é€ä»»åŠ¡
            'bpmn:SendTask', 'activity', 'bpmn-icon-send-task',
            translate('Create SendTask')
        ),
        'create.receive-task': createAction(//æ¥æ”¶ä»»åŠ¡
            'bpmn:ReceiveTask', 'activity', 'bpmn-icon-receive-task',
            translate('Create ReceiveTask')
        ),
        'create.business-rule-task': createAction(//ä¸šåŠ¡è§„åˆ™ä»»åŠ¡
            'bpmn:BusinessRuleTask', 'activity', 'bpmn-icon-business-rule-task',
            translate('Create BusinessRuleTask')
        ),
        'create.service-task': createAction(//æœåŠ¡ä»»åŠ¡
            'bpmn:ServiceTask', 'activity', 'bpmn-icon-service-task',
            translate('Create ServiceTask')
        ),
        'create.script-task': createAction(//è„šæœ¬ä»»åŠ¡
            'bpmn:ScriptTask', 'activity', 'bpmn-icon-script-task',
            translate('Create ScriptTask')
        ),
        'create.manual-task': createAction(//æ‰‹å·¥ä»»åŠ¡
            'bpmn:ManualTask', 'activity', 'bpmn-icon-manual-task',
            translate('Create ManualTask')
        ),
        'create.call-activity': createAction(//è°ƒç”¨æ´»åŠ¨
            'bpmn:CallActivity', 'activity', 'bpmn-icon-call-activity',
            translate('Create CallActivityTask')
        ),
        'create.subprocess-expanded': {//åˆ›å»ºå­æµç¨‹ï¼ˆå±•å¼€çš„ï¼‰
            group: 'activity',
            className: 'bpmn-icon-subprocess-expanded',
            title: translate('Create SubProcessExpanded'),
            action: {
                dragstart: createSubprocess,
                click: createSubprocess
            }
        },
        'task-separator': {//ä»»åŠ¡åˆ†å‰²çº¿
            group: 'tasks',
            separator: true
        },
        'create.data-object': createAction(//æ•°æ®å¯¹è±¡
            'bpmn:DataObjectReference', 'data-object', 'bpmn-icon-data-object',
            translate('Create DataObjectReference')
        ),
 
        'create.data-store': createAction(//æ•°æ®å­˜å‚¨å¼•ç”¨
            'bpmn:DataStoreReference', 'data-store', 'bpmn-icon-data-store',
            translate('Create DataStoreReference')
        ),
 
        'create.participant-expanded': {//æ± /å‚ä¸è€…
            group: 'collaboration',
            className: 'bpmn-icon-participant',
            title: translate('Create Pool/Participant'),
            action: {
                dragstart: createParticipant,
                click: createParticipant
            }
        },
        'create.group': createAction(//ç»„
            'bpmn:Group', 'artifact', 'bpmn-icon-group',
            translate('Create Group')
        )
}

```
>å†ä½¿ç”¨ createActions åˆ›å»ºé¢æ¿äº‹ä»¶

```js
function createAction(type, group, className, title, imageUrl) {

Â  Â  // è¿˜è®°å¾— CustomPalette.js å—ï¼Ÿä¾¿æ˜¯è¿™é‡Œå›è°ƒ createListener å‡½æ•°

Â  Â  // if (action === 'click') {

Â  Â  // handler(originalEvent, autoActivate, elementFactory, create)

Â  Â  // }

Â  Â  function createListener(event, autoActivate, elementFactory, create) {

Â  Â  Â  Â  var shape = elementFactory.createShape({ type })
Â  Â  Â  Â  create.start(event, shape)
Â  Â  }
Â  Â  
Â  Â  return {

Â  Â  Â  Â  group: group,

Â  Â  Â  Â  className: className,

Â  Â  Â  Â  title: title,

Â  Â  Â  Â  imageUrl, // ğŸ“Œ

Â  Â  Â  Â  action: {

Â  Â  Â  Â  Â  Â  dragstart: createListener,

Â  Â  Â  Â  Â  Â  click: createListener,

Â  Â  Â  Â  },

Â  Â  }
```
### 2.å·¥å…·æ ç±»å
>æŸ¥è¯¢é…ç½®æ–‡ä»¶ palrttteEntries.js ä¸­éœ€è¦çš„ç±»å  

```css

.bpmn-icon-screw-wrench:before { content: '\e800'; } /* 'î €' */
.bpmn-icon-trash:before { content: '\e801'; } /* 'î ' */
.bpmn-icon-conditional-flow:before { content: '\e802'; } /* 'î ‚' */
.bpmn-icon-default-flow:before { content: '\e803'; } /* 'î ƒ' */
.bpmn-icon-gateway-parallel:before { content: '\e804'; } /* 'î „' */
.bpmn-icon-intermediate-event-catch-cancel:before { content: '\e805'; } /* 'î …' */
.bpmn-icon-intermediate-event-catch-non-interrupting-message:before { content: '\e806'; } /* 'î †' */
.bpmn-icon-start-event-compensation:before { content: '\e807'; } /* 'î ‡' */
.bpmn-icon-start-event-non-interrupting-parallel-multiple:before { content: '\e808'; } /* 'î ˆ' */
.bpmn-icon-loop-marker:before { content: '\e809'; } /* 'î ‰' */
.bpmn-icon-parallel-mi-marker:before { content: '\e80a'; } /* 'î Š' */
.bpmn-icon-start-event-non-interrupting-signal:before { content: '\e80b'; } /* 'î ‹' */
.bpmn-icon-intermediate-event-catch-non-interrupting-timer:before { content: '\e80c'; } /* 'î Œ' */
.bpmn-icon-intermediate-event-catch-parallel-multiple:before { content: '\e80d'; } /* 'î ' */
.bpmn-icon-intermediate-event-catch-compensation:before { content: '\e80e'; } /* 'î ' */
.bpmn-icon-gateway-xor:before { content: '\e80f'; } /* 'î ' */
.bpmn-icon-connection:before { content: '\e810'; } /* 'î ' */
.bpmn-icon-end-event-cancel:before { content: '\e811'; } /* 'î ‘' */
.bpmn-icon-intermediate-event-catch-condition:before { content: '\e812'; } /* 'î ’' */
.bpmn-icon-intermediate-event-catch-non-interrupting-parallel-multiple:before { content: '\e813'; } /* 'î “' */
.bpmn-icon-start-event-condition:before { content: '\e814'; } /* 'î ”' */
.bpmn-icon-start-event-non-interrupting-timer:before { content: '\e815'; } /* 'î •' */
.bpmn-icon-sequential-mi-marker:before { content: '\e816'; } /* 'î –' */
.bpmn-icon-user-task:before { content: '\e817'; } /* 'î —' */
.bpmn-icon-business-rule:before { content: '\e818'; } /* 'î ˜' */
.bpmn-icon-sub-process-marker:before { content: '\e819'; } /* 'î ™' */
.bpmn-icon-start-event-parallel-multiple:before { content: '\e81a'; } /* 'î š' */
.bpmn-icon-start-event-error:before { content: '\e81b'; } /* 'î ›' */
.bpmn-icon-intermediate-event-catch-signal:before { content: '\e81c'; } /* 'î œ' */
.bpmn-icon-intermediate-event-catch-error:before { content: '\e81d'; } /* 'î ' */
.bpmn-icon-end-event-compensation:before { content: '\e81e'; } /* 'î ' */
.bpmn-icon-subprocess-collapsed:before { content: '\e81f'; } /* 'î Ÿ' */
.bpmn-icon-subprocess-expanded:before { content: '\e820'; } /* 'î  ' */
.bpmn-icon-task:before { content: '\e821'; } /* 'î ¡' */
.bpmn-icon-end-event-error:before { content: '\e822'; } /* 'î ¢' */
.bpmn-icon-intermediate-event-catch-escalation:before { content: '\e823'; } /* 'î £' */
.bpmn-icon-intermediate-event-catch-timer:before { content: '\e824'; } /* 'î ¤' */
.bpmn-icon-start-event-escalation:before { content: '\e825'; } /* 'î ¥' */
.bpmn-icon-start-event-signal:before { content: '\e826'; } /* 'î ¦' */
.bpmn-icon-business-rule-task:before { content: '\e827'; } /* 'î §' */
.bpmn-icon-manual:before { content: '\e828'; } /* 'î ¨' */
.bpmn-icon-receive:before { content: '\e829'; } /* 'î ©' */
.bpmn-icon-call-activity:before { content: '\e82a'; } /* 'î ª' */
.bpmn-icon-start-event-timer:before { content: '\e82b'; } /* 'î «' */
.bpmn-icon-start-event-message:before { content: '\e82c'; } /* 'î ¬' */
.bpmn-icon-intermediate-event-none:before { content: '\e82d'; } /* 'î ­' */
.bpmn-icon-intermediate-event-catch-link:before { content: '\e82e'; } /* 'î ®' */
.bpmn-icon-end-event-escalation:before { content: '\e82f'; } /* 'î ¯' */
.bpmn-icon-text-annotation:before { content: '\e830'; } /* 'î °' */
.bpmn-icon-bpmn-io:before { content: '\e831'; } /* 'î ±' */
.bpmn-icon-gateway-complex:before { content: '\e832'; } /* 'î ²' */
.bpmn-icon-gateway-eventbased:before { content: '\e833'; } /* 'î ³' */
.bpmn-icon-gateway-none:before { content: '\e834'; } /* 'î ´' */
.bpmn-icon-gateway-or:before { content: '\e835'; } /* 'î µ' */
.bpmn-icon-end-event-terminate:before { content: '\e836'; } /* 'î ¶' */
.bpmn-icon-end-event-signal:before { content: '\e837'; } /* 'î ·' */
.bpmn-icon-end-event-none:before { content: '\e838'; } /* 'î ¸' */
.bpmn-icon-end-event-multiple:before { content: '\e839'; } /* 'î ¹' */
.bpmn-icon-end-event-message:before { content: '\e83a'; } /* 'î º' */
.bpmn-icon-end-event-link:before { content: '\e83b'; } /* 'î »' */
.bpmn-icon-intermediate-event-catch-message:before { content: '\e83c'; } /* 'î ¼' */
.bpmn-icon-intermediate-event-throw-compensation:before { content: '\e83d'; } /* 'î ½' */
.bpmn-icon-start-event-multiple:before { content: '\e83e'; } /* 'î ¾' */
.bpmn-icon-script:before { content: '\e83f'; } /* 'î ¿' */
.bpmn-icon-manual-task:before { content: '\e840'; } /* 'î¡€' */
.bpmn-icon-send:before { content: '\e841'; } /* 'î¡' */
.bpmn-icon-service:before { content: '\e842'; } /* 'î¡‚' */
.bpmn-icon-receive-task:before { content: '\e843'; } /* 'î¡ƒ' */
.bpmn-icon-user:before { content: '\e844'; } /* 'î¡„' */
.bpmn-icon-start-event-none:before { content: '\e845'; } /* 'î¡…' */
.bpmn-icon-intermediate-event-throw-escalation:before { content: '\e846'; } /* 'î¡†' */
.bpmn-icon-intermediate-event-catch-multiple:before { content: '\e847'; } /* 'î¡‡' */
.bpmn-icon-intermediate-event-catch-non-interrupting-escalation:before { content: '\e848'; } /* 'î¡ˆ' */
.bpmn-icon-intermediate-event-throw-link:before { content: '\e849'; } /* 'î¡‰' */
.bpmn-icon-start-event-non-interrupting-condition:before { content: '\e84a'; } /* 'î¡Š' */
.bpmn-icon-data-object:before { content: '\e84b'; } /* 'î¡‹' */
.bpmn-icon-script-task:before { content: '\e84c'; } /* 'î¡Œ' */
.bpmn-icon-send-task:before { content: '\e84d'; } /* 'î¡' */
.bpmn-icon-data-store:before { content: '\e84e'; } /* 'î¡' */
.bpmn-icon-start-event-non-interrupting-escalation:before { content: '\e84f'; } /* 'î¡' */
.bpmn-icon-intermediate-event-throw-message:before { content: '\e850'; } /* 'î¡' */
.bpmn-icon-intermediate-event-catch-non-interrupting-multiple:before { content: '\e851'; } /* 'î¡‘' */
.bpmn-icon-intermediate-event-catch-non-interrupting-signal:before { content: '\e852'; } /* 'î¡’' */
.bpmn-icon-intermediate-event-throw-multiple:before { content: '\e853'; } /* 'î¡“' */
.bpmn-icon-start-event-non-interrupting-message:before { content: '\e854'; } /* 'î¡”' */
.bpmn-icon-ad-hoc-marker:before { content: '\e855'; } /* 'î¡•' */
.bpmn-icon-service-task:before { content: '\e856'; } /* 'î¡–' */
.bpmn-icon-task-none:before { content: '\e857'; } /* 'î¡—' */
.bpmn-icon-compensation-marker:before { content: '\e858'; } /* 'î¡˜' */
.bpmn-icon-start-event-non-interrupting-multiple:before { content: '\e859'; } /* 'î¡™' */
.bpmn-icon-intermediate-event-throw-signal:before { content: '\e85a'; } /* 'î¡š' */
.bpmn-icon-intermediate-event-catch-non-interrupting-condition:before { content: '\e85b'; } /* 'î¡›' */
.bpmn-icon-participant:before { content: '\e85c'; } /* 'î¡œ' */
.bpmn-icon-event-subprocess-expanded:before { content: '\e85d'; } /* 'î¡' */
.bpmn-icon-lane-insert-below:before { content: '\e85e'; } /* 'î¡' */
.bpmn-icon-space-tool:before { content: '\e85f'; } /* 'î¡Ÿ' */
.bpmn-icon-connection-multi:before { content: '\e860'; } /* 'î¡ ' */
.bpmn-icon-lane:before { content: '\e861'; } /* 'î¡¡' */
.bpmn-icon-lasso-tool:before { content: '\e862'; } /* 'î¡¢' */
.bpmn-icon-lane-insert-above:before { content: '\e863'; } /* 'î¡£' */
.bpmn-icon-lane-divide-three:before { content: '\e864'; } /* 'î¡¤' */
.bpmn-icon-lane-divide-two:before { content: '\e865'; } /* 'î¡¥' */
.bpmn-icon-data-input:before { content: '\e866'; } /* 'î¡¦' */
.bpmn-icon-data-output:before { content: '\e867'; } /* 'î¡§' */
.bpmn-icon-hand-tool:before { content: '\e868'; } /* 'î¡¨' */
.bpmn-icon-group:before { content: '\e869'; } /* 'î¡©' */
.bpmn-icon-transaction:before { content: '\e8c4'; } /* 'î£„' */
```

### 3.CustomPalette.js

>ä¿®æ”¹é»˜è®¤çš„é¢æ¿,åˆ›å»º CustomPalette.js

```js
import { isArray, isFunction, forEach } from 'min-dash'

import {
    domify,
    query as domQuery,
    attr as domAttr,
    clear as domClear,
    classes as domClasses,
    matches as domMatches,
    delegate as domDelegate,
    event as domEvent,
} from 'min-dom'

var TOGGLE_SELECTOR = '.djs-palette-toggle'
var ENTRY_SELECTOR = '.entry'
var ELEMENT_SELECTOR = TOGGLE_SELECTOR + ', ' + ENTRY_SELECTOR

var PALETTE_OPEN_CLS = 'open'
var PALETTE_TWO_COLUMN_CLS = 'two-column'

var DEFAULT_PRIORITY = 1000

/**
 * A palette containing modeling elements.
 */
export default function Palette(
    eventBus,
    canvas,
    elementFactory,
    create,
    paletteContainer,
    paletteEntries
) {
    this._eventBus = eventBus
    this._canvas = canvas
    // æ–°å¢èµ‹å€¼
    this._entries = paletteEntries // ä¼ å…¥çš„å·¥å…·æ æ•°æ®
    this._paletteContainer = paletteContainer // ä¼ å…¥çš„å·¥å…·æ å®¹å™¨
    this._elementFactory = elementFactory
    this._create = create

    var self = this
    eventBus.on('tool-manager.update', function (event) {
        var tool = event.tool

        self.updateToolHighlight(tool)
    })

    eventBus.on('i18n.changed', function () {
        self._update()
    })

    eventBus.on('diagram.init', function () {
        self._diagramInitialized = true

        self._rebuild()
    })
}

Palette.$inject = [
    'eventBus',
    'canvas',
    'elementFactory',
    'create',
    'config.paletteContainer',
    'config.paletteEntries',
]

/**
 * Register a provider with the palette
 *
 * @param  {number} [priority=1000]
 * @param  {PaletteProvider} provider
 *
 * @example
 * const paletteProvider = {
 *   getPaletteEntries: function() {
 *     return function(entries) {
 *       return {
 *         ...entries,
 *         'entry-1': {
 *           label: 'My Entry',
 *           action: function() { alert("I have been clicked!"); }
 *         }
 *       };
 *     }
 *   }
 * };
 *
 * palette.registerProvider(800, paletteProvider);
 */
Palette.prototype.registerProvider = function (priority, provider) {
    if (!provider) {
        provider = priority
        priority = DEFAULT_PRIORITY
    }

    this._eventBus.on('palette.getProviders', priority, function (event) {
        event.providers.push(provider)
    })

    this._rebuild()
}

/**
 * Returns the palette entries
 *
 * @return {Object<string, PaletteEntryDescriptor>} map of entries
 */
Palette.prototype.getEntries = function () {
    var providers = this._getProviders()

    return providers.reduce(addPaletteEntries, {})
}

Palette.prototype._rebuild = function () {
    if (!this._diagramInitialized) {
        return
    }

    var providers = this._getProviders()

    if (!providers.length) {
        return
    }

    if (!this._container) {
        this._init()
    }

    this._update()
}

/**
 * Initialize
 */
Palette.prototype._init = function () {
    var self = this

    var eventBus = this._eventBus

    var parentContainer = this._getParentContainer()

    var container = (this._container = domify(Palette.HTML_MARKUP))

    parentContainer.appendChild(container)

    domDelegate.bind(container, ELEMENT_SELECTOR, 'click', function (event) {
        var target = event.delegateTarget

        if (domMatches(target, TOGGLE_SELECTOR)) {
            return self.toggle()
        }

        self.trigger('click', event)
    })

    // prevent drag propagation
    domEvent.bind(container, 'mousedown', function (event) {
        event.stopPropagation()
    })

    // prevent drag propagation
    domDelegate.bind(container, ENTRY_SELECTOR, 'dragstart', function (event) {
        self.trigger('dragstart', event)
    })

    eventBus.on('canvas.resized', this._layoutChanged, this)

    eventBus.fire('palette.create', {
        container: container,
    })
}

Palette.prototype._getProviders = function (id) {
    var event = this._eventBus.createEvent({
        type: 'palette.getProviders',
        providers: [],
    })

    this._eventBus.fire(event)

    return event.providers
}

/**
 * Update palette state.
 *
 * @param  {Object} [state] { open, twoColumn }
 */
Palette.prototype._toggleState = function (state) {
    state = state || {}

    var parent = this._getParentContainer()
    var container = this._container

    var eventBus = this._eventBus

    var twoColumn

    var cls = domClasses(container)

    if ('twoColumn' in state) {
        twoColumn = state.twoColumn
    } else {
        twoColumn = this._needsCollapse(parent.clientHeight, this._entries || {})
    }

    // always update two column
    cls.toggle(PALETTE_TWO_COLUMN_CLS, twoColumn)

    if ('open' in state) {
        cls.toggle(PALETTE_OPEN_CLS, state.open)
    }

    eventBus.fire('palette.changed', {
        twoColumn: twoColumn,
        open: this.isOpen(),
    })
}

Palette.prototype._update = function () {
    var entriesContainer = domQuery('.djs-palette-entries', this._container)
    var entries = (this._entries = this.getEntries())

    domClear(entriesContainer)

    forEach(entries, function (entry, id) {
        var grouping = entry.group || 'default'

        var container = domQuery('[data-group=' + grouping + ']', entriesContainer)
        if (!container) {
            container = domify('<div class="group" data-group="' + grouping + '"></div>')
            entriesContainer.appendChild(container)
        }

        var html =
            entry.html ||
            (entry.separator
                ? '<hr class="separator" />'
                : '<div class="entry" draggable="true"></div>')

        var control = domify(html)
        container.appendChild(control)

        if (!entry.separator) {
            domAttr(control, 'data-action', id)

            if (entry.title) {
                domAttr(control, 'title', entry.title)
            }

            if (entry.className) {
                addClasses(control, entry.className)
            }

            if (entry.imageUrl) {
                control.appendChild(domify('<img src="' + entry.imageUrl + '">'))
            }
        }
    })

    // open after update
    this.open()
}

/**
 * Trigger an action available on the palette
 *
 * @param  {string} action
 * @param  {Event} event
 */
Palette.prototype.trigger = function (action, event, autoActivate) {
    var entries = this._entries
    var entry
    var handler
    var originalEvent
    var button = event.delegateTarget || event.target
    var elementFactory = this._elementFactory,
        create = this._create

    if (!button) {
        return event.preventDefault()
    }

    entry = entries[domAttr(button, 'data-action')]

    // when user clicks on the palette and not on an action
    if (!entry) {
        return
    }

    handler = entry.action

    originalEvent = event.originalEvent || event
    // simple action (via callback function)
    if (isFunction(handler)) {
        if (action === 'click') {
            handler(originalEvent, autoActivate, elementFactory, create)
        }
    } else {
        if (handler[action]) {
            handler[action](originalEvent, autoActivate, elementFactory, create)
        }
    }

    // silence other actions
    event.preventDefault()
}

Palette.prototype._layoutChanged = function () {
    this._toggleState({})
}

/**
 * Do we need to collapse to two columns?
 *
 * @param {number} availableHeight
 * @param {Object} entries
 *
 * @return {boolean}
 */
Palette.prototype._needsCollapse = function (availableHeight, entries) {
    // top margin + bottom toggle + bottom margin
    // implementors must override this method if they
    // change the palette styles
    var margin = 20 + 10 + 20

    var entriesHeight = Object.keys(entries).length * 46

    return availableHeight < entriesHeight + margin
}

/**
 * Close the palette
 */
Palette.prototype.close = function () {
    this._toggleState({
        open: false,
        twoColumn: false,
    })
}

/**
 * Open the palette
 */
Palette.prototype.open = function () {
    this._toggleState({ open: true })
}

Palette.prototype.toggle = function (open) {
    if (this.isOpen()) {
        this.close()
    } else {
        this.open()
    }
}

Palette.prototype.isActiveTool = function (tool) {
    return tool && this._activeTool === tool
}

Palette.prototype.updateToolHighlight = function (name) {
    var entriesContainer, toolsContainer

    if (!this._toolsContainer) {
        entriesContainer = domQuery('.djs-palette-entries', this._container)

        this._toolsContainer = domQuery('[data-group=tools]', entriesContainer)
    }

    toolsContainer = this._toolsContainer

    forEach(toolsContainer.children, function (tool) {
        var actionName = tool.getAttribute('data-action')

        if (!actionName) {
            return
        }

        var toolClasses = domClasses(tool)

        actionName = actionName.replace('-tool', '')

        if (toolClasses.contains('entry') && actionName === name) {
            toolClasses.add('highlighted-entry')
        } else {
            toolClasses.remove('highlighted-entry')
        }
    })
}

/**
 * Return true if the palette is opened.
 *
 * @example
 *
 * palette.open();
 *
 * if (palette.isOpen()) {
 *   // yes, we are open
 * }
 *
 * @return {boolean} true if palette is opened
 */
Palette.prototype.isOpen = function () {
    return domClasses(this._container).has(PALETTE_OPEN_CLS)
}

/**
 * Get container the palette lives in.
 *
 * @return {Element}
 */
Palette.prototype._getParentContainer = function () {
    return this._canvas.getContainer()
}

/* markup definition */

Palette.HTML_MARKUP =
    '<div class="djs-palette">' +
    '<div class="djs-palette-entries"></div>' +
    '<div class="djs-palette-toggle"></div>' +
    '</div>'

// helpers //////////////////////

function addClasses(element, classNames) {
    var classes = domClasses(element)

    var actualClassNames = isArray(classNames) ? classNames : classNames.split(/\s+/g)
    actualClassNames.forEach(function (cls) {
        classes.add(cls)
    })
}

function addPaletteEntries(entries, provider) {
    var entriesOrUpdater = provider.getPaletteEntries()

    if (isFunction(entriesOrUpdater)) {
        return entriesOrUpdater(entries)
    }

    forEach(entriesOrUpdater, function (entry, id) {
        entries[id] = entry
    })

    return entries
}
```

### 4.paletteEntries.js

> é¢æ¿æ§åˆ¶é…ç½®ï¼š
>
> + å®šä¹‰é¢æ¿ä¸­æ˜¯å¦æœ‰æŸä¸ªå…ƒç´ èŠ‚ç‚¹ã€‚
>
> + å¯¼å‡ºæ–°é…ç½®

```js
export default {
    //å·¥å…·æ é…ç½®é¡¹
    'event-separator': {
        //äº‹ä»¶åˆ†å‰²çº¿
        group: 'events',
        separator: true,
    },
    'create.start-event': createAction(
        'bpmn:StartEvent',
        'event',
        'bpmn-icon-start-event-none',
        'å¼€å§‹ä»»åŠ¡'
    ),
    'create.end-event': createAction(
        'bpmn:EndEvent',
        'event',
        'bpmn-icon-end-event-none',
        'ç»“æŸä»»åŠ¡'
    ),
    'task-separator': {
        //ä»»åŠ¡åˆ†å‰²çº¿
        group: 'tasks',
        separator: true,
    },
    'create.task': createAction(
        'bpmn:Task',
        'activity',
        'bpmn-icon-task', // ğŸ™‹â€â™‚ï¸ ä½¿ç”¨å›¾ç‰‡åï¼Œè®°å¾—ä¿®æ”¹æˆè‡ªå·±çš„ç±»å
        'åˆ›å»ºç©ºç™½ä»»åŠ¡'
        // require('../img/task.png') // ğŸ“Œ
    ),
    'create.user-task': createAction(
        //ç”¨æˆ·ä»»åŠ¡
        'bpmn:UserTask',
        'activity',
        'bpmn-icon-user-task',
        'åˆ›å»ºç”¨æˆ·ä»»åŠ¡'
    ),
    'create.service-task': createAction(
        //æœåŠ¡ä»»åŠ¡
        'bpmn:ServiceTask',
        'activity',
        'bpmn-icon-service-task',
        'åˆ›å»ºæœåŠ¡ä»»åŠ¡'
    ),

    'gateway-separator': {
        //ç½‘å…³åˆ†å‰²çº¿
        group: 'gateways',
        separator: true,
    },
    'create.exclusive-gateway': createAction(
        'bpmn:ExclusiveGateway',
        'gateway',
        'bpmn-icon-gateway-xor',
        'åˆ›å»ºäº’æ–¥ç½‘å…³'
    ),
    'create.parallel-gateway': createAction(
        'bpmn:ParallelGateway',
        'gateway',
        'bpmn-icon-gateway-parallel',
        'åˆ›å»ºå¹¶è¡Œç½‘å…³'
    ),
    'group-separator': {
        //ç½‘å…³åˆ†å‰²çº¿
        group: 'artifact',
        separator: true,
    },
    'create.group': createAction('bpmn:Group', 'artifact', 'bpmn-icon-group', 'åˆ›å»ºç»„'),
}

function createAction(type, group, className, title, imageUrl) {
    // è¿˜è®°å¾— CustomPalette.js å—ï¼Ÿä¾¿æ˜¯è¿™é‡Œå›è°ƒ createListener å‡½æ•°
    // if (action === 'click') {
    // handler(originalEvent, autoActivate, elementFactory, create)
    // }
    function createListener(event, autoActivate, elementFactory, create) {
        var shape = elementFactory.createShape({ type })

        create.start(event, shape)
    }

    return {
        group: group,
        className: className,
        title: title,
        imageUrl, // ğŸ“Œ
        action: {
            dragstart: createListener,
            click: createListener,
        },
    }
}

```

### 5.CustomPaletteProvider.js

> + é¢æ¿æ³¨å…¥ï¼Œè¿”å›å·¥å…·æ æ•°æ®
> + é»˜è®¤å¯¼å‡ºé¢æ¿é…ç½®
> + è¦†ç›–åŸé¢æ¿ï¼Œå¯¼å…¥æ–°é…ç½®
>
> ```js
> //å…ˆå¯¼å…¥
> //è‡ªå®šä¹‰é¢æ¿
>     const modules = Modeler.prototype._modules
>     const index = modules.findIndex((it: any) => it.paletteProvider)
>     modules.splice(index, 1)
>     bpmnModeler = new Modeler({
>         container: canvas.value,
>         paletteEntries,
>         additionalModules: [customPalette]
>     })

## 4.è‡ªå®šä¹‰å³ä¾§å±æ€§æ 

[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://github.com/bpmn-io/bpmn-js-examples/tree/master/properties-panel-extension)çš„æ€»ç»“

> ç”±äº 0.x ç‰ˆæœ¬å’Œ 1.x ç‰ˆæœ¬ çš„åŒ…ä¹‹é—´å­˜åœ¨åŒºåˆ«ï¼Œæ­¤æ¬¡çš„è‡ªå®šä¹‰çš„å†…å®¹åŸºäº 1.9.0 ç‰ˆæœ¬ã€‚

### 1.è‡ªå®šä¹‰ç›¸å…³çš„è‡ªå®šä¹‰å±æ€§çš„ json æ–‡ä»¶

> **æ³¨æ„ï¼š** 
> + è¿™é‡Œçš„ prefix çš„å€¼å’Œ type å­—æ®µä¸‹é¢æ¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå³æ¯ä¸€ä¸ªæ‰©å±•å±æ€§ï¼‰ä¸­çš„ name éœ€è¦æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œä¾‹å¦‚ â€œmagic : spellâ€ã€‚é€šè¿‡å¦‚ä¸Šæ ¼å¼å®ç°å¯¹æ–°å¢å±æ€§çš„ get å’Œ set
> + æ¯ä¸€æ¡å±æ€§ä¸­çš„ extends å­—æ®µï¼š
> 	+ ä¸åŠ è¯¥å­—æ®µï¼Œå¹¶ä¸” isAttr ä¸º false ï¼šåˆ™å½“å‰å±æ€§ä¼šå˜ä¸ºå½“å‰æµç¨‹èŠ‚ç‚¹çš„å±æ€§ã€‚
> 	+ åŠ è¯¥å­—æ®µï¼Œè¯´æ˜å½“å‰å±æ€§/æ ‡ç­¾æ˜¯ extends çš„å­èŠ‚ç‚¹
> 		+ å¦‚æœ isAttr ä¸º false ï¼Œåˆ™å½“å‰å±æ€§åå­—ä¼šå˜ä¸ºå­æ ‡ç­¾ã€‚
> 		+ å¦‚æœ isAttr ä¸º true , åˆ™å½“å‰å±æ€§ä¼šå˜ä¸º ï¼ˆprefixï¼‰:å±æ€§åï¼Œä½œä¸ºå½“å‰èŠ‚ç‚¹çš„å±æ€§ã€‚

```json
{
    "name": "Magic",
    "prefix": "magic",
    "uri": "http://ntc",
    "xml": {
        "tagAlias": "lowerCase"
    },
    "associations": [],
    "types": [
        {
            "name": "OtherTaskProps",
            "extends": ["bpmn:Task"],
            "properties": [
                {
                    "name": "spell",
                    "isAttr": true,
                    "type": "String"
                },
                {
                    "name": "value",
                    "isAttr": true,
                    "type": "String"
                }
            ]
        },
        {
            "name": "TaskProps",
            "extends": ["bpmn:StartEvent"],
            "properties": [
                {
                    "name": "inputProp",
                    "isAttr": true,
                    "type": "String"
                },
                {
                    "name": "inputValue",
                    "isAttr": true,
                    "type": "String"
                }
            ]
        }
    ]
}
```

### 2.åˆ›å»ºå±æ€§å¯¹åº”çš„ *PropertiesProviderModule* 

### 1. åŸç”Ÿé¢æ¿
### 2. è‡ªå®šä¹‰é¢æ¿


 

## 5. å¸¸ç”¨ API

### 1.importXMLï¼ˆï¼‰

> åœ¨åˆ›å»ºå®ä¾‹ä¹‹åå¯¼å…¥æµç¨‹æ¨¡æ¿ï¼ˆå³XMLæ–‡ä»¶ï¼‰

### 2.saveXMLï¼ˆï¼‰

> æŠŠæµç¨‹å†…å®¹å¯¼å‡ºä¸º XML æ–‡ä»¶

### 3.saveSVGï¼ˆï¼‰

> æŠŠæµç¨‹å®ä¾‹ä¿å­˜ä¸º SVG æ–‡ä»¶

### 4.getï¼ˆ'eventBus'ï¼‰







